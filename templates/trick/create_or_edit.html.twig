{% extends 'base.html.twig' %}

{% block title %}
    {% if edit %}
        Edit
    {% else %}
        Create    
    {% endif %}    
{% endblock %}

{% block body %}

    <h1 class="text-center">
        {% if edit %}
            Edit {{ trick.title }}
        {% else %}
            Create    
        {% endif %}  
    </h1>

    {{ form_start(form) }}
        {{ form_label(form.title, 'Title', {'label_attr': {'class': 'd-block text-center'}}) }}
        {{ form_widget(form.title, {'attr': {'class': 'form-control mb-2 mt-2'}}) }}

        {{ form_label(form.description, 'Description', {'label_attr': {'class': 'd-block text-center'}}) }}
        {{ form_widget(form.description, {'attr': {'class': 'form-control mb-2 mt-2'}}) }}

        {{ form_label(form.category, 'Group', {'label_attr': {'class': 'd-block text-center'}}) }}
        {{ form_widget(form.category, {'attr': {'class': 'form-control mb-2 mt-2'}}) }}

        {{ form_label(form.images, 'Images', {'label_attr': {'class': 'd-block text-center'}}) }}
        {{ form_widget(form.images, {'attr': {'class': 'form-control mb-2 mt-2'}}) }}

        <button type="submit" class="btn btn-success">Submit</button>
    {{ form_end(form) }}

    {% if edit %}
        <div class="d-flex js-data-images" data-slug={{trick.slug}}>
            {% set index = 0 %}
            {% for image in trick.images %}
                <div id="{{image}}" class="p-2" style="width: 20%; height: 12rem; overflow: hidden;">
                    <img src="https://127.0.0.1:8000/assets/images/tricks/{{image}}"
                        alt=""
                        style="width: 100%;"
                        class="js-images"
                        data-image={{image}}
                    >
                    {% if index > 0 %}
                        <btn id="main-{{image}}" class="btn btn-primary mt-2">Set as main image</btn>
                    {% endif %}
                    <btn id="delete-{{image}}" class="btn btn-danger mt-2 float-end">
                        <i class="fa-solid fa-trash"></i>
                    </btn>
                </div>
                {% set index = index + 1 %}
            {% endfor %}
        </div>
        <div class="d-flex">
            {% set index = 0 %}
            {% for video in trick.videos %}
                <div id="video-{{index}}" class="p-2" style="width: 20%; height: 16rem; overflow: hidden;">
                    <iframe width="100%"
                        height="80%"
                        src={{video}}
                        title="YouTube video player"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        allowfullscreen>
                    </iframe>
                    <btn class="js-videos btn btn-danger mt-2 float-end">
                        <i class="fa-solid fa-trash"></i>
                    </btn>
                </div>
                {% set index = index + 1 %}
            {% endfor %}
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {

                const div = document.querySelector('.js-data-images');
                const imagesElement = div.getElementsByClassName('js-images');
                const removeVideoButtons = document.getElementsByClassName('js-videos');
                const slug = div.dataset.slug;

                const init = {method: 'GET', mode: 'cors', cache: 'default'};

                // delete image or set as main image
                for(let i = 0; i < imagesElement.length; i++){
                    let image = imagesElement[i].dataset.image;
                    let deleteButton = document.getElementById(`delete-${image}`);
                    let mainImageButton = document.getElementById(`main-${image}`);

                    deleteButton.addEventListener('click', function(){
                        let confirm = window.confirm('Confirm you want to delete this image.');

                        if(confirm){
                            let request = new Request(`https://127.0.0.1:8000/trick/edit/${slug}/remove-image/${image}`, init);
    
                            fetch(request).then(function(response){
                                if(response.ok && response.status === 200){
                                    document.getElementById(image).style.display = 'none';
                                }
                            });
                        }
                    });

                    if(mainImageButton){
                        mainImageButton.addEventListener('click', function(){
                            let confirm = window.confirm('Confirm you want to set this image as main image.');

                            if(confirm){
                                let request = new Request(`https://127.0.0.1:8000/trick/edit/${slug}/main-image/${image}`, init);
        
                                fetch(request).then(function(response){
                                    if(response.ok && response.status === 200){
                                        document.getElementById(`main-${image}`).innerHTML  = 'new main image';
                                    }
                                });
                            }
                        });
                    }
                }

                // delete video
                for(let i = 0; i < removeVideoButtons.length; i++){
                    removeVideoButtons[i].addEventListener('click', function(){
                        let confirm = window.confirm('Confirm you want to delete this video.');

                        if(confirm){
                            let request = new Request(`https://127.0.0.1:8000/trick/edit/${slug}/remove-video/${i}`, init);
    
                            fetch(request).then(function(response){
                                if(response.ok && response.status === 200){
                                    document.getElementById(`video-${i}`).style.display = 'none';
                                }
                            });
                        }
                    });
                }

            });
        </script>
    {% endif %}
{% endblock %}
